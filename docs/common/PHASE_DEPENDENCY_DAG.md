# Phase依存関係DAG

**バージョン**: 1.0.0  
**最終更新**: 2025-10-22  
**Author**: System Architect  
**目的**: 実装順序・ブロッカー判断の明確化

---

## 全体フロー図

```
┌─────────────────────────────────────────────────────────────────┐
│                    実装フェーズ1: データ収集                            │
│                  (DATA_COLLECTOR_SPEC.md)                        │
│  - MT5生データ取得（M1/M5/M15/H1/H4 + Tick）                      │
│  - タイムスタンプUTC変換・検証                                     │
│  - 未確定バー除外                                                 │
│  - HDF5保存（raw phase）                                         │
└──────────────────┬──────────────────────────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────────────────────────┐
│          実装フェーズ2: タイムスタンプ整合・特徴量計算                   │
│   (TIMESTAMP_ALIGNMENT_SPEC + FEATURE_CALCULATOR_SPEC)          │
│  - マルチTF時刻揃え（欠損検出・補完）                              │
│  - 特徴量計算（テクニカル指標・マイクロ構造）                       │
│  - NaN除外（phase1: 5%, phase2: 1%）                             │
│  - HDF5保存（aligned, features phase）                           │
└──────────────────┬──────────────────────────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────────────────────────┐
│              実装フェーズ3: 前処理・シーケンス化                         │
│                  (PREPROCESSOR_SPEC.md)                          │
│  - 品質フィルタ（低分散・高相関除外）                              │
│  - RobustScaler正規化                                            │
│  - シーケンス生成（360→36 window）                                │
│  - 未来リーク検証（境界条件チェック）                              │
│  - HDF5保存（sequences phase）                                   │
└──────────────────┬──────────────────────────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────────────────────────┐
│                   Phase 4: 学習                                  │
│                  (TRAINER_SPEC.md)                               │
│  - マルチTF融合モデル（M5/M15/H1同時処理）                         │
│  - マルチタスク学習（方向+価格幅）                                 │
│  - 動的TP/SL（モード判定: scalp/swing）                           │
│  - Walk-forward検証                                              │
│  - モデル保存（trained phase）                                    │
└──────────────────┬──────────────────────────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────────────────────────┐
│                 Phase 5: 検証・評価                               │
│                  (VALIDATOR_SPEC.md)                             │
│  - バックテスト（デュアルモード対応）                              │
│  - ドリフト検出（PSI, ECE）                                       │
│  - 未来リーク再検証                                               │
│  - 性能レポート生成                                               │
└──────────────────┬──────────────────────────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────────────────────────┐
│                Phase 6: ONNX変換（オプション）                     │
│                (ONNX_CONVERTER_SPEC.md)                          │
│  - PyTorch → ONNX変換                                            │
│  - スケール二重換算検証                                           │
│  - INT8量子化（Phase 3-4最適化後）                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## Phase別依存関係詳細

### 実装フェーズ1: データ収集

**ブロッカー**: なし（最初のフェーズ）

**依存ツール**:
- MT5 API接続
- Docker環境（NVIDIA GPU推奨）

**成果物**:
- `{symbol}_{tf}_raw_{timestamp}.h5`
- メタデータJSON

**完了条件**:
- [ ] 全TF（M1/M5/M15/H1/H4）のデータ取得成功
- [ ] タイムスタンプUTC変換完了
- [ ] 品質検証パス（欠損率<0.5%）
- [ ] HDF5書き込み成功

---

### 実装フェーズ2: 特徴量計算

**ブロッカー**: Phase 1完了必須

**依存データ**:
- Phase 1の raw HDF5ファイル

**並行実装可能**:
- TIMESTAMP_ALIGNMENT（タイムスタンプ整合）
- FEATURE_CALCULATOR（特徴量計算）

**成果物**:
- `{symbol}_multi_aligned_{timestamp}.h5`
- `{symbol}_multi_features_{timestamp}.h5`

**完了条件**:
- [ ] マルチTF時刻揃え完了
- [ ] 特徴量計算完了（30-100列）
- [ ] NaN閾値検証パス（phase1: 5%, phase2: 1%）
- [ ] メタデータ保存

---

### 実装フェーズ3: 前処理

**ブロッカー**: Phase 2完了必須

**依存データ**:
- Phase 2の features HDF5ファイル

**成果物**:
- `{symbol}_multi_sequences_{timestamp}.h5`
- スケーラーパラメータJSON
- 特徴量名リスト

**完了条件**:
- [ ] 品質フィルタ完了（低分散・高相関除外）
- [ ] 正規化完了（RobustScaler）
- [ ] シーケンス生成完了（shape検証）
- [ ] 未来リーク検証パス

---

### Phase 4: 学習

**ブロッカー**: Phase 3完了必須

**依存データ**:
- Phase 3の sequences HDF5ファイル

**並行可能な開発**:
- モデルアーキテクチャ設計
- 損失関数実装
- 評価指標実装

**成果物**:
- `{symbol}_multi_trained_{timestamp}.h5`
- モデル重み（.pt, .pth）
- 学習ログ・メトリクス

**完了条件**:
- [ ] 学習収束（loss安定化）
- [ ] 検証精度目標達成
- [ ] モデル保存成功

---

### Phase 5: 検証

**ブロッカー**: Phase 4完了必須

**依存データ**:
- Phase 4の trained モデル
- Phase 3の sequences（検証用）

**成果物**:
- バックテストレポート（JSON）
- ドリフト検出結果
- 混同行列・散布図

**完了条件**:
- [ ] バックテスト実行成功
- [ ] 期待値>0確認
- [ ] ドリフト検出異常なし
- [ ] 未来リーク再検証パス

---

### Phase 6: ONNX変換（オプション）

**ブロッカー**: Phase 5完了必須

**依存データ**:
- Phase 4の trained モデル
- Phase 3のスケーラーパラメータ

**成果物**:
- `.onnx` モデルファイル
- INT8量子化モデル（オプション）
- 検証レポート

**完了条件**:
- [ ] ONNX変換成功
- [ ] 精度検証（PyTorch vs ONNX差異<1e-5）
- [ ] スケール二重換算なし確認
- [ ] 推論速度測定

---

## 実装マイルストーン

### Milestone 1: データ基盤構築（Phase 1-2）

**期間**: 2週間（想定）

**タスク**:
1. MT5データ収集実装
2. タイムスタンプ整合実装
3. 特徴量計算器実装（基本セット）
4. 命名規約・ストレージポリシー適用

**ブロッカー解消**:
- MT5 API接続確認
- Docker環境構築
- HDF5読み書きテスト

---

### Milestone 2: 前処理・学習準備（Phase 3）

**期間**: 1週間（想定）

**タスク**:
1. 品質フィルタ実装
2. 正規化実装
3. シーケンス生成実装
4. 未来リーク検証統合

**ブロッカー解消**:
- Phase 2の成果物確認
- シーケンス長・形状仕様確定

---

### Milestone 3: 学習・検証（Phase 4-5）

**期間**: 2-3週間（想定）

**タスク**:
1. マルチTF融合モデル実装
2. マルチタスク学習実装
3. Walk-forward検証実装
4. バックテスト・ドリフト検出実装

**ブロッカー解消**:
- GPU環境確認
- 学習データ準備完了

---

### Milestone 4: 最適化・運用準備（Phase 6以降）

**期間**: 継続的

**タスク**:
1. ONNX変換（オプション）
2. INT8量子化（Phase 3-4後）
3. Incremental LSTM推論最適化（P4）
4. レイテンシ最適化（P4）

**ブロッカー解消**:
- 運用データ蓄積
- 性能ボトルネック特定

---

## Phase間データフロー

```
[MT5 API]
    ↓
[raw.h5] ──────┐
    ↓          │
[aligned.h5]   │ タイムスタンプ検証
    ↓          │ (UTC変換・単調性)
[features.h5] ─┘
    ↓
[sequences.h5] ─┐
    ↓           │ 未来リーク検証
[trained.pt]    │ (境界条件チェック)
    ↓           │
[validation/] ──┘
    ↓
[onnx_model/] (オプション)
```

---

## ブロッカー解消チェックリスト

### Phase 1 → Phase 2

- [ ] raw.h5ファイル存在確認
- [ ] メタデータ読み込み成功
- [ ] タイムスタンプ範囲確認

### Phase 2 → Phase 3

- [ ] features.h5ファイル存在確認
- [ ] 特徴量数が範囲内（30-100列）
- [ ] NaN比率<1%

### Phase 3 → Phase 4

- [ ] sequences.h5ファイル存在確認
- [ ] シーケンス形状確認（features: N×360×F, targets: N×36×1）
- [ ] スケーラーパラメータJSON確認

### Phase 4 → Phase 5

- [ ] trained モデルファイル存在確認
- [ ] モデルロード成功
- [ ] メタデータ整合性確認

### Phase 5 → Phase 6

- [ ] 検証レポート確認
- [ ] 期待値>0確認
- [ ] ドリフト異常なし確認

---

## トラブルシューティング

### Phase間ブロック時の対処

| 症状 | 原因候補 | 対処 |
|------|---------|------|
| Phase 2で特徴量数不足 | カテゴリ無効化 | config YAML確認 |
| Phase 3でシーケンス生成失敗 | 時系列不連続 | Phase 2の欠損処理確認 |
| Phase 4で学習不収束 | データ不足/品質低 | Phase 3のフィルタ緩和 |
| Phase 5で期待値<0 | コストモデル未調整 | スプレッド・スリッページ見直し |

---

## 関連仕様書

- `README.md`: 全体概要・9段階ワークフロー
- `NAMING_CONVENTION.md`: ファイル命名・世代管理
- `STORAGE_POLICY_SPEC.md`: データ保持・アーカイブ
- `FUTURE_LEAK_PREVENTION_SPEC.md`: 未来リーク防止検証

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2025-10-22 | 1.0.0 | 初版作成 |
