# 将来拡張仕様（Future Enhancements）

このドキュメントは、基盤実装完了後の運用フェーズで検討すべき最適化・拡張項目を記録します。

## 目的

- 基盤仕様を肥大化させず、将来の改善方向性を保持する
- 運用データ蓄積後に実装すべき項目を明確化する
- 最適化フェーズ（実装フェーズ3-4）での検討事項を整理する

## 前提条件

これらの拡張は以下が完了していることを前提とします：
- ✅ 基盤実装完了（第1-6段階のメイン仕様実装）
- ✅ 本番運用開始
- ✅ 運用データ蓄積（最低3ヶ月）
- ✅ 基本KPI達成

---

## 1. レイテンシ最適化

### 1.1 Latency×Slippage相関ログ（項目100）

**目的**: 遅延増加とスリッページ悪化の相関を監視し、最適化方向を特定する。

**実装**:
- joint_histogram: latency_bucket × slippage_bucket
- correlation_metric: Pearson/Spearman係数
- 相関検出時の改善施策実行ログ

**成功指標**:
- 相関検出で改善施策実行ログ記録

**実装フェーズ**: Phase 3-4（運用監視）

### 1.2 レイテンシ依存Fillモデル（項目103）

**目的**: レイテンシ別の約定率変動を反映し、期待値推定精度を向上させる。

**実装**:
```python
expectancy_adj = raw_expectancy * fill_rate(latency_bucket)
```

**成功指標**:
- 期待値推定誤差 < 5%

**実装フェーズ**: Phase 3-4（運用データ必要）

### 1.3 micro-lag計測基準（項目107）

**目的**: サブミリ秒遅延蓄積の原因を切り分ける。

**実装**:
- monotonic_ns タイムスタンプ
- sync markers による区間計測
- lag variance 分析

**成功指標**:
- lag variance減少

**実装フェーズ**: Phase 3-4（高度な監視機能）

---

## 2. コスト最適化

### 2.1 コスト要素同時最適化ロス（項目99）

**目的**: 方向精度偏重を防ぎ、ネット利益最大化に寄与する損失関数を構築する。

**実装**:
```python
composite_loss = direction_loss + λ_cost * cost_penalty
```

**成功指標**:
- cost-adjusted expectancy > 0 のサンプル率 +10%

**実装フェーズ**: Phase 3-4（最適化フェーズ）

### 2.2 スプレッド閾値適応（項目104）

**目的**: 固定spread閾値によるregime shift時の誤判定を防止する。

**実装**:
```python
dynamic_thr = quantile(spread, q=0.75) + ATR_ratio
```

**成功指標**:
- false_entry減少 ≥ 10%

**実装フェーズ**: Phase 3-4（運用最適化）

### 2.3 Spread jumpクールダウン（項目115）

**目的**: スプレッド急拡大直後の再突入による連続負期待値を防止する。

**実装**:
```python
cooldown_ticks = N  # N tick間エントリ抑制
```

**成功指標**:
- jump直後損失減少

**実装フェーズ**: Phase 3-4（運用最適化）

### 2.4 コスト自動再推定（項目113）

**目的**: コストモデル陳腐化による期待値偏差を防止する。

**実装**:
- daily reestimate
- delta drift log
- 閾値超過時アラート

**成功指標**:
- コスト推定誤差 < 5%

**実装フェーズ**: Phase 3-4（運用フェーズ）

---

## 3. 信号品質向上

### 3.1 信号クラスタ検出（項目101）

**目的**: バースト発生によるスリッページ連鎖を防止する。

**実装**:
- run_length検出
- DBSCAN cluster size log
- burst制御メカニズム

**成功指標**:
- burst制御後slip減少 ≥ 15%

**実装フェーズ**: Phase 3-4（運用最適化）

### 3.2 クラス不均衡動的調整（項目117）

**目的**: クラス偏り進行による少数派recall低下を防止する。

**実装**:
```python
ema_ratio → adaptive_weight
```

**成功指標**:
- minority recall ≥ baseline

**実装フェーズ**: Phase 3-4（運用最適化）

---

## 4. モデル保守

### 4.1 軽量再校正層（項目109）

**目的**: 微小drift時のフル再学習コストを削減する。

**実装**:
- lightweight_calibrator（温度パラメータ + 線形変換）
- drift検出時の自動適用

**成功指標**:
- retrain回数 -20%

**実装フェーズ**: Phase 3-4（運用最適化フェーズ）

### 4.2 Feature重要度ドリフト追跡（項目111）

**目的**: 重要度変化を監視し、陳腐化特徴量を検出する。

**実装**:
- SHAP rank shift追跡
- shift > threshold時再選抜トリガー

**成功指標**:
- shiftアラート適切発火

**実装フェーズ**: Phase 3-4（運用監視）

---

## 5. リスク管理

### 5.1 急変時Fail-safe（項目112）

**目的**: 極端spike中の継続取引による損失拡大を防止する。

**実装**:
```python
if fail_safe_trigger(spike_detected):
    position_size = 0
```

**成功指標**:
- spike損失削減 ≥ 30%

**実装フェーズ**: Phase 3-4（運用安全機構）

### 5.2 直後逆行統計蓄積（項目114）

**目的**: 初期逆行パターン分析によるSL最適化。

**実装**:
- adverse_excursion tracking
- 統計的SL調整アルゴリズム

**成功指標**:
- SL調整後MDD減少

**実装フェーズ**: Phase 3-4（運用データ蓄積後）

---

## 6. 運用監視

### 6.1 Post-trade収集（項目110）

**目的**: 実現収益ログによる期待値較正を可能にする。

**実装**:
- realized expectancy集計
- MAE/MFE実績記録
- 予測値との較正分析

**成功指標**:
- 校正改善（較正MSE減少）

**実装フェーズ**: Phase 3-4（運用フェーズで必須）

---

## 実装優先順位

### Phase 3（最適化フェーズ）での優先項目

1. **Post-trade収集（6.1）**: 運用開始と同時に必須
2. **コスト自動再推定（2.4）**: 期待値精度維持に重要
3. **軽量再校正層（4.1）**: 再学習コスト削減

### Phase 4（運用監視フェーズ）での検討項目

1. **Latency×Slippage相関ログ（1.1）**
2. **Feature重要度ドリフト追跡（4.2）**
3. **急変時Fail-safe（5.1）**

### 長期的拡張項目

- レイテンシ依存Fillモデル（1.2）
- コスト要素同時最適化ロス（2.1）
- 信号クラスタ検出（3.1）

---

## 注意事項

- これらの拡張は**基盤実装完了後**に検討する
- 各項目は運用データが蓄積されてから実装判断を行う
- 基盤仕様書を肥大化させないため、このドキュメントに集約する
- 実装時は対応する仕様書に詳細を追記する

---

**作成日**: 2025-10-22
**対象フェーズ**: Phase 3-4（最適化・運用監視）
