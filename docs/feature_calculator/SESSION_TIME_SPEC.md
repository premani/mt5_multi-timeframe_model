# ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»æ™‚é–“ä»•æ§˜æ›¸

**ã‚«ãƒ†ã‚´ãƒª**: 5/5
**å‡¦ç†æ®µéšŽ**: ç¬¬2æ®µéšŽ: ç‰¹å¾´é‡è¨ˆç®—
**åˆ—æ•°**: 5-8åˆ—  
**ç›®çš„**: æ™‚é–“å¸¯ã«ã‚ˆã‚‹å¸‚å ´ç‰¹æ€§åæ˜ 

---

## ðŸ“‹ æ¦‚è¦

æ™‚åˆ»ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆæ±äº¬/æ¬§å·ž/NYï¼‰ã«ã‚ˆã‚‹å¸‚å ´ç‰¹æ€§ã‚’ç‰¹å¾´é‡åŒ–ã€‚æ™‚åˆ»ã®å‘¨æœŸæ€§ã‚’sin/coså¤‰æ›ã§è¡¨ç¾ã—ã€ãƒ¢ãƒ‡ãƒ«ãŒ**æ™‚é–“å¸¯å›ºæœ‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³**ã‚’å­¦ç¿’ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

### è¨­è¨ˆæ–¹é‡
- **æ™‚åˆ»ã®å‘¨æœŸæ€§**: sin/coså¤‰æ›ï¼ˆç·šå½¢ãªå€¤ã§ã¯ãªãå‘¨æœŸçš„ãªå€¤ï¼‰
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¤å®š**: æ±äº¬/æ¬§å·ž/NYã®3ã‚»ãƒƒã‚·ãƒ§ãƒ³
- **æ›œæ—¥åŠ¹æžœ**: é€±åˆ/é€±æœ«ã®ç‰¹æ€§

### æ™‚åˆ»ç®¡ç†æ–¹é‡
- **ç‰¹å¾´é‡è¨ˆç®—**: UTCæ™‚åˆ»ã§å‡¦ç†
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³å®šç¾©**: UTCåŸºæº–ã§å®šç¾©ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã«JSTå‚è€ƒæƒ…å ±ã‚’ä½µè¨˜ï¼‰
- **ãƒ­ã‚°å‡ºåŠ›**: æ—¥æœ¬æ™‚é–“(JST)ã§è¡¨ç¤º
- è©³ç´°: [docs/utils/TIMEZONE_UTILS_SPEC.md](../utils/TIMEZONE_UTILS_SPEC.md)

---

## ðŸŽ¯ ç‰¹å¾´é‡è©³ç´°

### 1. æ™‚åˆ»ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆ4åˆ—ï¼‰

æ™‚åˆ»ï¼ˆhour/minuteï¼‰ã‚’å‘¨æœŸçš„ãªå€¤ã«å¤‰æ›ã€‚

#### 1-1. æ™‚åˆ»sin/cosï¼ˆ24æ™‚é–“å‘¨æœŸï¼‰

```python
import numpy as np

# UTCæ™‚åˆ»ã‚’å–å¾—
time = raw_data['M5']['time']
hour = time.dt.hour
minute = time.dt.minute

# 24æ™‚é–“å‘¨æœŸã®sin/coså¤‰æ›
features['hour_sin'] = np.sin(2 * np.pi * hour / 24)
features['hour_cos'] = np.cos(2 * np.pi * hour / 24)

# 60åˆ†å‘¨æœŸã®sin/coså¤‰æ›
features['minute_sin'] = np.sin(2 * np.pi * minute / 60)
features['minute_cos'] = np.cos(2 * np.pi * minute / 60)
```

**ãªãœsin/coså¤‰æ›ï¼Ÿ**
- æ™‚åˆ»ã¯å‘¨æœŸçš„ï¼ˆ23æ™‚â†’0æ™‚ã¯é€£ç¶šï¼‰
- å˜ç´”ãªæ•´æ•°å€¤ã ã¨ã€0æ™‚ã¨23æ™‚ãŒé ã„å€¤ã«ãªã‚‹
- sin/cosã‚’ä½¿ã†ã“ã¨ã§ã€0æ™‚ã¨23æ™‚ãŒè¿‘ã„å€¤ã«ãªã‚‹

**å€¤åŸŸ**: å„åˆ—ã¨ã‚‚ -1.0 ~ +1.0

**ä¾‹**:
```python
# 0æ™‚ï¼ˆUTCï¼‰
hour_sin = sin(2Ï€ * 0 / 24) = 0.0
hour_cos = cos(2Ï€ * 0 / 24) = 1.0

# 6æ™‚ï¼ˆUTCï¼‰
hour_sin = sin(2Ï€ * 6 / 24) = 1.0
hour_cos = cos(2Ï€ * 6 / 24) = 0.0

# 12æ™‚ï¼ˆUTCï¼‰
hour_sin = sin(2Ï€ * 12 / 24) = 0.0
hour_cos = cos(2Ï€ * 12 / 24) = -1.0

# 18æ™‚ï¼ˆUTCï¼‰
hour_sin = sin(2Ï€ * 18 / 24) = -1.0
hour_cos = cos(2Ï€ * 18 / 24) = 0.0
```

---

### 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¤å®šï¼ˆ3åˆ—ï¼‰

#### 2-1. æ±äº¬ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆUTC 0:00-6:00ï¼‰

```python
# UTCæ™‚åˆ»åŸºæº–
# æ±äº¬ã‚»ãƒƒã‚·ãƒ§ãƒ³: JST 9:00-15:00 = UTC 0:00-6:00
features['session_tokyo'] = (
    (hour >= 0) & (hour < 6)
).astype(int)
```

**å€¤**: 0 or 1

---

#### 2-2. æ¬§å·žã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆUTC 7:00-15:00ï¼‰

```python
# æ¬§å·žã‚»ãƒƒã‚·ãƒ§ãƒ³: GMT 8:00-16:00 = UTC 7:00-15:00ï¼ˆå¤æ™‚é–“è€ƒæ…®ï¼‰
features['session_europe'] = (
    (hour >= 7) & (hour < 15)
).astype(int)
```

---

#### 2-3. NYã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆUTC 13:00-21:00ï¼‰

```python
# NYã‚»ãƒƒã‚·ãƒ§ãƒ³: EST 8:00-16:00 = UTC 13:00-21:00ï¼ˆå¤æ™‚é–“è€ƒæ…®ï¼‰
features['session_ny'] = (
    (hour >= 13) & (hour < 21)
).astype(int)
```

**æ³¨æ„**: æ¬§å·žã¨NYã¯é‡è¤‡æ™‚é–“å¸¯ã‚ã‚Šï¼ˆUTC 13:00-15:00ï¼‰

---

### 3. æ›œæ—¥åŠ¹æžœï¼ˆ2åˆ—ï¼‰

#### 3-1. é€±åˆï¼ˆæœˆæ›œï¼‰

```python
day_of_week = time.dt.dayofweek  # 0=æœˆæ›œ, 6=æ—¥æ›œ

features['is_monday'] = (day_of_week == 0).astype(int)
```

**æ„å‘³**: é€±åˆã®ä¾¡æ ¼è·³ã­ï¼ˆé€±æœ«ã‚®ãƒ£ãƒƒãƒ—ï¼‰

---

#### 3-2. é€±æœ«ï¼ˆé‡‘æ›œï¼‰

```python
features['is_friday'] = (day_of_week == 4).astype(int)
```

**æ„å‘³**: é€±æœ«å‰ã®ãƒã‚¸ã‚·ãƒ§ãƒ³èª¿æ•´

---

### 4. ã‚»ãƒƒã‚·ãƒ§ãƒ³é‡è¤‡åˆ¤å®šï¼ˆ1åˆ—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```python
features['session_overlap'] = (
    features['session_europe'] & features['session_ny']
).astype(int)
```

**æ„å‘³**: æ¬§å·žã¨NYã®é‡è¤‡æ™‚é–“å¸¯ï¼ˆæœ€ã‚‚æµå‹•æ€§ãŒé«˜ã„ï¼‰

**å€¤**: 0 or 1

---

## ðŸ§® å®Ÿè£…ã‚¯ãƒ©ã‚¹

```python
class SessionTimeCalculator(BaseCalculator):
    """
    ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»æ™‚é–“ç‰¹å¾´é‡è¨ˆç®—å™¨
    """
    
    @property
    def name(self) -> str:
        return "session_time"
    
    def compute(
        self, 
        raw_data: Dict[str, pd.DataFrame]
    ) -> pd.DataFrame:
        """
        æ™‚åˆ»ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç‰¹å¾´é‡ã‚’è¨ˆç®—
        
        Returns:
            features: DataFrame(N, 8)
        """
        features = {}
        
        # M5ã®æ™‚åˆ»ã‚’å–å¾—ï¼ˆå…¨TFå…±é€šï¼‰
        time = raw_data['M5']['time']
        hour = time.dt.hour
        minute = time.dt.minute
        day_of_week = time.dt.dayofweek
        
        # æ™‚åˆ»ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆ4åˆ—ï¼‰
        features['hour_sin'] = np.sin(2 * np.pi * hour / 24)
        features['hour_cos'] = np.cos(2 * np.pi * hour / 24)
        features['minute_sin'] = np.sin(2 * np.pi * minute / 60)
        features['minute_cos'] = np.cos(2 * np.pi * minute / 60)
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¤å®šï¼ˆ3åˆ—ï¼‰
        features['session_tokyo'] = (
            (hour >= 0) & (hour < 6)
        ).astype(int)
        
        features['session_europe'] = (
            (hour >= 7) & (hour < 15)
        ).astype(int)
        
        features['session_ny'] = (
            (hour >= 13) & (hour < 21)
        ).astype(int)
        
        # æ›œæ—¥åŠ¹æžœï¼ˆ2åˆ—ï¼‰
        features['is_monday'] = (day_of_week == 0).astype(int)
        features['is_friday'] = (day_of_week == 4).astype(int)
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³é‡è¤‡ï¼ˆ1åˆ—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        features['session_overlap'] = (
            features['session_tokyo'] & features['session_ny']
        ).astype(int)
        
        return pd.DataFrame(features)
```

---

## âœ… æ¤œè¨¼åŸºæº–

### 1. NaNæ¯”çŽ‡
- **é–¾å€¤**: 0%
- **ç†ç”±**: æ™‚åˆ»æƒ…å ±ã¯å¿…ãšå­˜åœ¨ã€NaNç™ºç”Ÿãªã—

### 2. å€¤ã®ç¯„å›²
- `hour_sin`, `hour_cos`: -1.0 ~ +1.0
- `minute_sin`, `minute_cos`: -1.0 ~ +1.0
- `session_*`: 0 or 1
- `is_monday`, `is_friday`: 0 or 1
- `session_overlap`: 0 or 1

### 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†å¸ƒ
- å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé©åˆ‡ãªæ¯”çŽ‡ã§å‡ºç¾ã™ã‚‹ã“ã¨
  - æ±äº¬: â‰ˆ 25%ï¼ˆ6æ™‚é–“/24æ™‚é–“ï¼‰
  - æ¬§å·ž: â‰ˆ 33%ï¼ˆ8æ™‚é–“/24æ™‚é–“ï¼‰
  - NY: â‰ˆ 33%ï¼ˆ8æ™‚é–“/24æ™‚é–“ï¼‰
  - é‡è¤‡: â‰ˆ 8%ï¼ˆ2æ™‚é–“/24æ™‚é–“ï¼‰

---

## ðŸ“Š å‡ºåŠ›ä¾‹

```python
# å‡ºåŠ›DataFrameï¼ˆN, 8ï¼‰
features = pd.DataFrame({
    # æ™‚åˆ»ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆ4åˆ—ï¼‰
    'hour_sin': [0.0, 0.26, 0.5, ...],       # UTC 0æ™‚, 1æ™‚, 2æ™‚
    'hour_cos': [1.0, 0.97, 0.87, ...],
    'minute_sin': [0.0, 0.1, 0.2, ...],      # 0åˆ†, 6åˆ†, 12åˆ†
    'minute_cos': [1.0, 0.99, 0.98, ...],
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¤å®šï¼ˆ3åˆ—ï¼‰
    'session_tokyo': [1, 1, 1, 0, 0, ...],   # UTC 0-5æ™‚ã¯1
    'session_europe': [0, 0, 0, 1, 1, ...],  # UTC 7-14æ™‚ã¯1
    'session_ny': [0, 0, 0, 1, 1, ...],      # UTC 13-20æ™‚ã¯1
    
    # æ›œæ—¥åŠ¹æžœï¼ˆ2åˆ—ï¼‰
    'is_monday': [1, 0, 0, 0, 0, ...],       # æœˆæ›œã®ã¿1
    'is_friday': [0, 0, 0, 0, 1, ...],       # é‡‘æ›œã®ã¿1
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³é‡è¤‡ï¼ˆ1åˆ—ï¼‰
    'session_overlap': [0, 0, 0, 1, 0, ...], # UTC 13-14æ™‚ã®ã¿1
})
```

---

## ðŸŒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š

### UTCåŸºæº–ã®ç†ç”±
- MT5ã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»ã¯é€šå¸¸UTC+2/+3ï¼ˆå¤æ™‚é–“ï¼‰
- ã—ã‹ã—å–å¼•æˆ¦ç•¥ã¯**ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªæ™‚åˆ»**ã«ä¾å­˜
- UTCçµ±ä¸€ã§ä¸€è²«æ€§ã‚’ä¿ã¤

### ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›ï¼ˆå‚è€ƒï¼‰

```python
# MT5ã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»ï¼ˆUTC+2ï¼‰ã‚’UTCã«å¤‰æ›
import pytz

mt5_time = pd.to_datetime('2025-10-22 10:00:00')  # MT5ã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»
mt5_tz = pytz.timezone('Europe/Helsinki')  # UTC+2/+3
utc_tz = pytz.UTC

# UTCã«å¤‰æ›
time_utc = mt5_tz.localize(mt5_time).astimezone(utc_tz)
```

---

## ðŸš¨ æ³¨æ„äº‹é …

### å¤æ™‚é–“ã®æ‰±ã„
- æ¬§å·ž/NYã¯å¤æ™‚é–“ã¨å†¬æ™‚é–“ã§1æ™‚é–“ãšã‚Œã‚‹
- æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯**å¤æ™‚é–“ã‚’æ¨™æº–**ã¨ã™ã‚‹
- å†¬æ™‚é–“ã®å¯¾å¿œã¯å°†æ¥æ‹¡å¼µ

### ã‚»ãƒƒã‚·ãƒ§ãƒ³é‡è¤‡ã®æ„ç¾©
- æ¬§å·žã¨NYã®é‡è¤‡æ™‚é–“å¸¯ï¼ˆUTC 13:00-15:00ï¼‰ã¯æœ€ã‚‚æµå‹•æ€§ãŒé«˜ã„
- ä¾¡æ ¼å¤‰å‹•ãŒå¤§ãããªã‚‹å‚¾å‘
- ã“ã®æ™‚é–“å¸¯ã‚’ç‰¹åˆ¥ã«æ‰±ã†ã“ã¨ã§ç²¾åº¦å‘ä¸Šã®å¯èƒ½æ€§

### æ›œæ—¥åŠ¹æžœã®é™å®šçš„ä½¿ç”¨
- é€±åˆï¼ˆæœˆæ›œï¼‰ã¨é€±æœ«ï¼ˆé‡‘æ›œï¼‰ã®ã¿ç‰¹å¾´åŒ–
- ç«/æ°´/æœ¨ã¯ä¸­ç«‹ã¨ã—ã¦æ‰±ã†
- éŽåº¦ãªæ›œæ—¥ä¾å­˜ã‚’é¿ã‘ã‚‹

---

## ðŸ”— é–¢é€£ä»•æ§˜æ›¸

- **ãƒ¡ã‚¤ãƒ³ä»•æ§˜**: [FEATURE_CALCULATOR_SPEC.md](../FEATURE_CALCULATOR_SPEC.md)
- **åŸºæœ¬ç‰¹å¾´é‡**: [BASIC_MULTI_TF_SPEC.md](./BASIC_MULTI_TF_SPEC.md)
- **ãƒ‡ãƒ¼ã‚¿åŽé›†**: [DATA_COLLECTOR_SPEC.md](../DATA_COLLECTOR_SPEC.md)

---

## ðŸ“š å‚è€ƒè³‡æ–™

### ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“å¸¯ï¼ˆUTCåŸºæº–ï¼‰

| ã‚»ãƒƒã‚·ãƒ§ãƒ³ | ç¾åœ°æ™‚åˆ» | UTCæ™‚åˆ» | ç‰¹å¾´ |
|----------|---------|---------|------|
| **æ±äº¬** | JST 9:00-15:00 | UTC 0:00-6:00 | ã‚¢ã‚¸ã‚¢é€šè²¨æ´»ç™º |
| **æ¬§å·ž** | GMT 8:00-16:00 | UTC 7:00-15:00 | EUR/GBPæ´»ç™º |
| **NY** | EST 8:00-16:00 | UTC 13:00-21:00 | USDæ´»ç™º |
| **é‡è¤‡** | - | UTC 13:00-15:00 | æœ€é«˜æµå‹•æ€§ |

### æ™‚åˆ»ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å‚è€ƒæ–‡çŒ®
- Circular Features in Machine Learning: https://ianlondon.github.io/blog/encoding-cyclical-features-24hour-time/

---

**æœ€çµ‚æ›´æ–°**: 2025-10-22  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ãƒ‰ãƒ©ãƒ•ãƒˆ
